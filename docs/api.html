<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API Reference — Pramana</title>
  <meta name="description" content="Pramana API endpoint reference — submission, chart data, user stats, admin compaction.">
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <button class="nav-toggle" onclick="document.querySelector('nav').classList.toggle('open')">&#9776;</button>
  <div class="layout">
    <nav>
      <div class="logo">
        <a href="https://syd-ppt.github.io/pramana/">pramana</a>
        <span class="sanskrit">प्रमाण</span>
      </div>
      <ul>
        <li class="nav-section">CLI</li>
        <li><a href="https://syd-ppt.github.io/pramana/">Overview</a></li>
        <li><a href="https://syd-ppt.github.io/pramana/quickstart.html">Quick Start</a></li>
        <li><a href="https://syd-ppt.github.io/pramana/cli.html">CLI Reference</a></li>
        <li class="nav-section">API &amp; Dashboard</li>
        <li><a href="index.html">Overview</a></li>
        <li><a href="getting-started.html">Getting Started</a></li>
        <li><a href="api.html" class="active">API Reference</a></li>
        <li><a href="methodology.html">Methodology</a></li>
        <li class="nav-section">Internals</li>
        <li><a href="https://syd-ppt.github.io/pramana/architecture.html">Architecture</a></li>
        <li><a href="https://syd-ppt.github.io/pramana/providers.html">Providers</a></li>
        <li><a href="https://syd-ppt.github.io/pramana/suites.html">Test Suites</a></li>
        <li><a href="https://syd-ppt.github.io/pramana/reproducibility.html">Reproducibility</a></li>
        <li class="nav-section">Community</li>
        <li><a href="https://syd-ppt.github.io/pramana/contributing.html">Contributing</a></li>
      </ul>
      <div class="ext-links">
        <a href="https://github.com/syd-ppt/pramana">GitHub (CLI)</a>
        <a href="https://github.com/syd-ppt/pramana-api">GitHub (API)</a>
        <a href="https://pypi.org/project/pramana/">PyPI</a>
        <a href="https://pramana.pages.dev">Dashboard</a>
      </div>
    </nav>
    <main>
      <h1>API Reference</h1>
      <p class="page-desc">Base URL: <code>https://pramana.pages.dev/api</code></p>

      <div class="callout">
        All endpoints return JSON. Authentication uses JWT bearer tokens obtained via OAuth.
        <span class="badge green">soft</span> = accepts anonymous.
        <span class="badge amber">auth</span> = requires valid token.
      </div>

      <!-- POST /api/submit -->
      <h2>Submit Result</h2>
      <div class="endpoint">
        <span class="method method-post">POST</span> /api/submit <span class="badge green">soft</span>
      </div>
      <p>Submit a single eval result.</p>

      <h3>Request body</h3>
      <table>
        <thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead>
        <tbody>
          <tr><td><code>model_id</code></td><td>string</td><td>yes</td><td>Model identifier, max 256 chars</td></tr>
          <tr><td><code>prompt_id</code></td><td>string</td><td>yes</td><td>Prompt/eval identifier, max 256 chars</td></tr>
          <tr><td><code>output</code></td><td>string</td><td>yes</td><td>Model output, max 1MB</td></tr>
          <tr><td><code>score</code></td><td>number</td><td>no</td><td>Score in [0, 1]. Omit if unscored.</td></tr>
          <tr><td><code>metadata</code></td><td>object</td><td>no</td><td>Arbitrary key-value pairs</td></tr>
        </tbody>
      </table>

      <h3>Example</h3>
      <pre><code>curl -X POST https://pramana.pages.dev/api/submit \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "model_id": "gpt-4o",
    "prompt_id": "factuality-q42",
    "output": "The capital of France is Paris.",
    "score": 1.0,
    "metadata": {"suite": "factuality", "version": "1.2"}
  }'</code></pre>

      <h3>Response</h3>
      <pre><code>{
  "id": "uuid-v4",
  "status": "accepted",
  "timestamp": "2026-02-22T12:00:00Z"
}</code></pre>

      <!-- POST /api/submit/batch -->
      <h2>Batch Submit</h2>
      <div class="endpoint">
        <span class="method method-post">POST</span> /api/submit/batch <span class="badge green">soft</span>
      </div>
      <p>Submit a batch of eval results (up to 1000). This is what <code>pramana submit</code> calls.</p>

      <h3>Request body</h3>
      <table>
        <thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead>
        <tbody>
          <tr><td><code>suite_version</code></td><td>string</td><td>yes</td><td>Version of the eval suite</td></tr>
          <tr><td><code>suite_hash</code></td><td>string</td><td>yes</td><td>Content hash of the suite</td></tr>
          <tr><td><code>model_id</code></td><td>string</td><td>yes</td><td>Model identifier</td></tr>
          <tr><td><code>temperature</code></td><td>number</td><td>yes</td><td>Temperature used for generation</td></tr>
          <tr><td><code>seed</code></td><td>number|null</td><td>no</td><td>Random seed if deterministic</td></tr>
          <tr><td><code>timestamp</code></td><td>string</td><td>yes</td><td>ISO 8601 timestamp</td></tr>
          <tr><td><code>results</code></td><td>array</td><td>yes</td><td>Array of submission objects (max 1000)</td></tr>
        </tbody>
      </table>

      <!-- GET /api/data/chart -->
      <h2>Chart Data</h2>
      <div class="endpoint">
        <span class="method method-get">GET</span> /api/data/chart
      </div>
      <p>Returns pre-aggregated chart data. Single R2 GET, cached.</p>

      <h3>Response shape</h3>
      <pre><code>{
  "data": [
    {
      "date": "2026-02-20",
      "gpt-4o": 32,
      "gpt-4o_prompts": 10,
      "gpt-4o_unique_outputs": 10,
      "gpt-4o_drifted": 0,
      "gpt-4o_consistency": 1.0
    }
  ],
  "models": ["gpt-4o", "claude-3.5-sonnet"],
  "total_submissions": 12840,
  "total_contributors": 47
}</code></pre>

      <div class="callout">
        <strong>Per model per date:</strong> <code>model</code> = submission count, <code>model_prompts</code> = unique prompts tested,
        <code>model_unique_outputs</code> = distinct output hashes, <code>model_drifted</code> = prompts whose output changed vs previous day,
        <code>model_consistency</code> = (prompts - drifted) / prompts. See <a href="methodology.html">Methodology</a>.
      </div>

      <!-- GET /api/user/me/summary -->
      <h2>User Summary</h2>
      <div class="endpoint">
        <span class="method method-get">GET</span> /api/user/me/summary <span class="badge amber">auth</span>
      </div>
      <p>Returns the authenticated user's submission summary.</p>

      <h3>Response shape (<code>UserSummaryJson</code>)</h3>
      <pre><code>{
  "version": 3,
  "submissions_by_date": {
    "2026-02-20": { "gpt-4o": 10, "claude-3.5-sonnet": 5 }
  },
  "model_submissions": { "gpt-4o": 340, "claude-3.5-sonnet": 180 },
  "total_submissions": 520
}</code></pre>

      <!-- GET /api/user/me/stats -->
      <h2>User Stats</h2>
      <div class="endpoint">
        <span class="method method-get">GET</span> /api/user/me/stats <span class="badge amber">auth</span>
      </div>
      <p>Returns computed statistics for the authenticated user (derived from summary).</p>

      <!-- DELETE /api/user/me -->
      <h2>Delete User Data</h2>
      <div class="endpoint">
        <span class="method method-delete">DELETE</span> /api/user/me <span class="badge amber">auth</span>
      </div>
      <p>GDPR data deletion. Removes the user's summary JSON from R2. Archived CSV submissions are anonymized via hashed user IDs and not modified.</p>

      <!-- POST /api/admin/compact -->
      <h2>Compact (Admin/Cron)</h2>
      <div class="endpoint">
        <span class="method method-post">POST</span> /api/admin/compact <span class="badge amber">auth</span>
      </div>
      <p>Triggered daily by GitHub Actions cron. Requires <code>Authorization: Bearer $CRON_SECRET</code>.</p>
      <ol>
        <li>Archive current buffer.csv.gz → _archive/YYYY-MM-DD.csv.gz</li>
        <li>Rebuild _aggregated/chart_data.json from all archives + historical parquet</li>
        <li>Reset buffer</li>
      </ol>

      <!-- Health -->
      <h2>Health Check</h2>
      <div class="endpoint">
        <span class="method method-get">GET</span> /api/health
      </div>
      <pre><code>{ "status": "ok" }</code></pre>

      <!-- Auth -->
      <h2>Authentication</h2>
      <p>OAuth flow endpoints. Used by the dashboard SPA, not by CLI directly.</p>
      <table>
        <thead><tr><th>Endpoint</th><th>Description</th></tr></thead>
        <tbody>
          <tr><td><code>GET /api/auth/providers</code></td><td>List available OAuth providers</td></tr>
          <tr><td><code>GET /api/auth/signin/:provider</code></td><td>Redirect to OAuth provider</td></tr>
          <tr><td><code>GET /api/auth/callback/:provider</code></td><td>OAuth callback, sets JWT cookie</td></tr>
          <tr><td><code>GET /api/auth/session</code></td><td>Returns current session info</td></tr>
          <tr><td><code>POST /api/auth/signout</code></td><td>Clears JWT cookie</td></tr>
        </tbody>
      </table>

      <!-- Storage -->
      <h2>Storage Schema</h2>
      <p>CSV records stored in buffer and archive files (12 fields):</p>
      <table>
        <thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead>
        <tbody>
          <tr><td><code>id</code></td><td>string</td><td>UUID v4</td></tr>
          <tr><td><code>timestamp</code></td><td>string</td><td>ISO 8601</td></tr>
          <tr><td><code>user_id</code></td><td>string</td><td>SHA-256 derived from OAuth identity</td></tr>
          <tr><td><code>model_id</code></td><td>string</td><td>Model identifier</td></tr>
          <tr><td><code>prompt_id</code></td><td>string</td><td>Prompt/eval identifier</td></tr>
          <tr><td><code>output</code></td><td>string</td><td>Model output text</td></tr>
          <tr><td><code>output_hash</code></td><td>string</td><td>SHA-256 of output</td></tr>
          <tr><td><code>metadata_json</code></td><td>string</td><td>JSON-encoded metadata</td></tr>
          <tr><td><code>year</code></td><td>number</td><td>Partition year</td></tr>
          <tr><td><code>month</code></td><td>number</td><td>Partition month</td></tr>
          <tr><td><code>day</code></td><td>number</td><td>Partition day</td></tr>
          <tr><td><code>score</code></td><td>number|null</td><td>Score in [0, 1]</td></tr>
        </tbody>
      </table>
    </main>
  </div>
</body>
</html>
